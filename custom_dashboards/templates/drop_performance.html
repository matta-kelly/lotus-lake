{% extends "base.html" %}
{% block content %}
<div class="container">
  <h1>Drop Performance Dashboard</h1>

  {% if error %}
  <div
    style="padding: 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;">
    <strong>Error:</strong> {{ error }}
  </div>
  {% endif %}

  <div class="filters-container">
    <div>
      <label for="tagFilter">Filter by Product Tag:</label>
      <select id="tagFilter" class="form-select">
        <option value="">-- Select a tag --</option>
        {% for tag in tags %}
        <option value="{{ tag }}">{{ tag }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate" class="form-select">
    </div>
    <div>
      <label for="endDate">End Date:</label>
      <input type="date" id="endDate" class="form-select">
    </div>
    <div class="date-range-buttons">
      <label>Quick Ranges (from release):</label>
      <div>
        <button data-days="7" class="btn-range">7 Days</button>
        <button data-days="14" class="btn-range">14 Days</button>
        <button data-days="30" class="btn-range">30 Days</button>
        <button data-days="90" class="btn-range">90 Days</button>
        <button data-days="all" class="btn-range">All Time</button>
      </div>
    </div>
  </div>


  <table id="resultsTable" class="data-table" style="display:none;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Units Sold</th>
        <th>Revenue</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // Get references to all filter elements
  const tagFilter = document.getElementById("tagFilter");
  const startDateFilter = document.getElementById("startDate");
  const endDateFilter = document.getElementById("endDate");
  const table = document.getElementById("resultsTable");
  const tbody = table.querySelector("tbody");
  const rangeButtons = document.querySelectorAll('.btn-range');

  let releaseDate = null; // Variable to store the release date for the selected tag

  // Function to fetch and render data
  async function fetchData() {
    const tag = tagFilter.value;
    const startDate = startDateFilter.value;
    const endDate = endDateFilter.value;

    tbody.innerHTML = "";

    if (!tag) {
      table.style.display = "none";
      return;
    }

    let apiUrl = `/api/drop-performance?tag=${encodeURIComponent(tag)}`;
    if (startDate && endDate) {
      apiUrl += `&start_date=${startDate}&end_date=${endDate}`;
    }

    const res = await fetch(apiUrl);
    const data = await res.json();

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.product_name}</td>
        <td>${row.units_sold}</td>
        <td>$${row.revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
      `;
      tbody.appendChild(tr);
    });

    table.style.display = "table";
  }

  // Function to set date range from buttons
  function setDateRange(days) {
    if (!releaseDate) {
        alert("Please select a drop to get its release date first.");
        return;
    };

    const startDate = new Date(releaseDate + 'T00:00:00'); // Add time to avoid timezone issues
    
    if (days === 'all') {
      startDateFilter.value = '';
      endDateFilter.value = '';
    } else {
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + (days - 1));
      
      startDateFilter.value = startDate.toISOString().split('T')[0];
      endDateFilter.value = endDate.toISOString().split('T')[0];
    }
    
    fetchData();
  }

  // --- Event Listeners ---
  tagFilter.addEventListener("change", async () => {
    const tag = tagFilter.value;
    releaseDate = null;
    rangeButtons.forEach(btn => btn.classList.remove('active'));
    startDateFilter.value = '';
    endDateFilter.value = '';

    if (tag) {
      const res = await fetch(`/api/get-release-date?tag=${encodeURIComponent(tag)}`);
      const data = await res.json();
      if (data.release_date) {
        releaseDate = data.release_date;
      }
    }
    fetchData();
  });

  startDateFilter.addEventListener("change", () => {
    rangeButtons.forEach(btn => btn.classList.remove('active'));
    fetchData();
  });
  endDateFilter.addEventListener("change", () => {
    rangeButtons.forEach(btn => btn.classList.remove('active'));
    fetchData();
  });

  rangeButtons.forEach(button => {
    button.addEventListener('click', () => {
      rangeButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      const days = button.dataset.days;
      setDateRange(days === 'all' ? 'all' : parseInt(days));
    });
  });
</script>
{% endblock %}