# ==============================================================================
# Dagster Helm Release (lotus-lake)
# ==============================================================================
# Orchestration for this lake
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
  namespace: lotus-lake
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: dagster
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: lotus-lake

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    # -------------------------------------------------------------------------
    # Use external PostgreSQL (CNPG)
    # -------------------------------------------------------------------------
    postgresql:
      enabled: false
      # External PostgreSQL connection for init containers
      postgresqlHost: "dagster-db-rw.lotus-lake.svc.cluster.local"
      postgresqlPort: 5432
      postgresqlUsername: "dagster"
      postgresqlDatabase: "dagster"

    generatePostgresqlPasswordSecret: false

    dagsterWebserver:
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    dagsterDaemon:
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    global:
      postgresqlSecretName: "dagster-db-app"
      postgresqlSecretKey: "password"
      postgresqlHost: "dagster-db-rw.lotus-lake.svc.cluster.local"
      postgresqlPort: 5432
      postgresqlUsername: "dagster"
      postgresqlDatabase: "dagster"

    runLauncher:
      type: K8sRunLauncher
      config:
        k8sRunLauncher:
          envSecrets:
            - name: dagster-db-app

    # -------------------------------------------------------------------------
    # Instance config pointing to CNPG
    # -------------------------------------------------------------------------
    dagster-user-deployments:
      enabled: true
      deployments:
        - name: lotus-lake
          image:
            repository: ghcr.io/matta-kelly/lotus-lake
            tag: latest
            pullPolicy: Always
          dagsterApiGrpcArgs:
            - "-m"
            - "orchestration.definitions"
          port: 3030
          env:
            - name: DAGSTER_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dagster-db-app
                  key: password
            # DuckLake (Postgres catalog)
            - name: DUCKLAKE_DB_HOST
              value: "ducklake-db-rw.lotus-lake.svc.cluster.local"
            - name: DUCKLAKE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ducklake-db-app
                  key: password
            # S3 (SeaweedFS)
            - name: S3_ENDPOINT
              value: "http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333"
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: minio_user
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: minio_password

    # -------------------------------------------------------------------------
    # Ingress
    # -------------------------------------------------------------------------
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/router.middlewares: kube-system-authentik-lotus-lake@kubernetescrd
      webserver:
        host: dagster.landl.datamountainsolutions.com
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: dagster-tls

    # -------------------------------------------------------------------------
    # Storage config
    # -------------------------------------------------------------------------
    computeLogManager:
      type: S3ComputeLogManager
      config:
        s3ComputeLogManager:
          bucket: lotus-lake-logs
          endpointUrl: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
          skipEmptyFiles: true
