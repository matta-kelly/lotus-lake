# ==============================================================================
# Dagster Helm Release (lotus-lake)
# ==============================================================================
# Orchestration for this lake
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
  namespace: lotus-lake
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: dagster
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: lotus-lake

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    # -------------------------------------------------------------------------
    # Use external PostgreSQL (CNPG)
    # -------------------------------------------------------------------------
    postgresql:
      enabled: false
      # External PostgreSQL connection for init containers
      postgresqlHost: "dagster-db-rw.lotus-lake.svc.cluster.local"
      postgresqlPort: 5432
      postgresqlUsername: "dagster"
      postgresqlDatabase: "dagster"

    generatePostgresqlPasswordSecret: false

    dagsterWebserver:
      nodeSelector:
        kubernetes.io/hostname: monkeybusiness
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    # -------------------------------------------------------------------------
    # Instance config (goes into dagster.yaml)
    # -------------------------------------------------------------------------
    additionalInstanceConfig:
      auto_materialize:
        enabled: true
        use_sensors: true

    dagsterDaemon:
      runCoordinator:
        enabled: true
        type: QueuedRunCoordinator
        config:
          queuedRunCoordinator:
            maxConcurrentRuns: 5
            tagConcurrencyLimits:
              - key: "workload"
                value: "feeder"
                limit: 2
              - key: "workload"
                value: "dlt"
                limit: 3
      nodeSelector:
        kubernetes.io/hostname: monkeybusiness
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    global:
      postgresqlSecretName: "dagster-db-app"
      postgresqlSecretKey: "password"
      postgresqlHost: "dagster-db-rw.lotus-lake.svc.cluster.local"
      postgresqlPort: 5432
      postgresqlUsername: "dagster"
      postgresqlDatabase: "dagster"

    runLauncher:
      type: K8sRunLauncher
      config:
        k8sRunLauncher:
          # Default config for all runs
          runK8sConfig:
            podSpecConfig:
              nodeSelector:
                kubernetes.io/hostname: monkeybusiness
            containerConfig:
              resources:
                limits:
                  memory: "15Gi"
                requests:
                  memory: "2Gi"
          # Per-asset image overrides are set via dagster-k8s/config tag in assets.py
          envSecrets:
            - name: dagster-db-app
            - name: lotus-lake-terraform-vars
            - name: ducklake-db-app
          envVars:
            - "DUCKLAKE_DB_HOST=ducklake-db-rw.lotus-lake.svc.cluster.local"
            - "S3_ENDPOINT=seaweedfs-s3.seaweedfs.svc.cluster.local:8333"

    # -------------------------------------------------------------------------
    # Instance config pointing to CNPG
    # -------------------------------------------------------------------------
    dagster-user-deployments:
      enabled: true
      deployments:
        - name: lotus-lake
          image:
            repository: ghcr.io/matta-kelly/lotus-lake
            tag: 529cdff  # Auto-updated by CI
            pullPolicy: IfNotPresent
          dagsterApiGrpcArgs:
            - "-m"
            - "orchestration.definitions"
          port: 3030
          nodeSelector:
            kubernetes.io/hostname: monkeybusiness
          env:
            - name: DAGSTER_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dagster-db-app
                  key: password
            # DuckLake (Postgres catalog)
            - name: DUCKLAKE_DB_HOST
              value: "ducklake-db-rw.lotus-lake.svc.cluster.local"
            - name: DUCKLAKE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ducklake-db-app
                  key: password
            # S3 (SeaweedFS) - no http:// prefix, DuckDB uses s3_use_ssl setting
            - name: S3_ENDPOINT
              value: "seaweedfs-s3.seaweedfs.svc.cluster.local:8333"
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: s3_access_key_id
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: s3_secret_access_key
            # Odoo
            - name: ODOO_URL
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: ODOO_URL
            - name: ODOO_DB
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: ODOO_DB
            - name: ODOO_USER
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: ODOO_USER
            - name: ODOO_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: ODOO_PASSWORD

    # -------------------------------------------------------------------------
    # Ingress
    # -------------------------------------------------------------------------
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/router.middlewares: kube-system-authentik-lotus-lake@kubernetescrd
      webserver:
        host: dagster.landl.datamountainsolutions.com
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: dagster-tls

    # -------------------------------------------------------------------------
    # Storage config
    # -------------------------------------------------------------------------
    # S3ComputeLogManager disabled - boto3 needs AWS_* env vars which conflict
    # with our minio_* naming. Using default local logs for now.
    # TODO: Re-enable once we have proper credential mapping
    # computeLogManager:
    #   type: S3ComputeLogManager
    #   config:
    #     s3ComputeLogManager:
    #       bucket: lotus-lake-logs
    #       endpointUrl: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
    #       skipEmptyFiles: true
