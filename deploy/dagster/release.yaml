# ==============================================================================
# Dagster Helm Release (lotus-lake)
# ==============================================================================
# Orchestration for this lake
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
  namespace: lotus-lake
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: dagster
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: flux-system

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    # -------------------------------------------------------------------------
    # Use external PostgreSQL (CNPG)
    # -------------------------------------------------------------------------
    postgresql:
      enabled: false

    generatePostgresqlPasswordSecret: false

    dagsterWebserver:
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    dagsterDaemon:
      env:
        - name: DAGSTER_PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dagster-db-app
              key: password

    global:
      postgresqlSecretName: ""

    runLauncher:
      type: K8sRunLauncher
      config:
        k8sRunLauncher:
          envSecrets:
            - name: dagster-db-app

    # -------------------------------------------------------------------------
    # Instance config pointing to CNPG
    # -------------------------------------------------------------------------
    dagster-user-deployments:
      enabled: true
      deployments:
        - name: lotus-lake
          image:
            repository: ghcr.io/lotusandluna/lotus-lake
            tag: latest
            pullPolicy: Always
          dagsterApiGrpcArgs:
            - "-m"
            - "orchestration.definitions"
          port: 3030
          env:
            - name: DAGSTER_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dagster-db-app
                  key: password
            # Airbyte connection
            - name: AIRBYTE_HOST
              value: "http://airbyte-server.airbyte.svc.cluster.local:8001"
            # DuckLake (Postgres catalog)
            - name: DUCKLAKE_DB_HOST
              value: "ducklake-db-rw.lotus-lake.svc.cluster.local"
            - name: DUCKLAKE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ducklake-db-app
                  key: password
            # S3 (SeaweedFS)
            - name: S3_ENDPOINT
              value: "http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333"
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-secrets
                  key: minio_user
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-secrets
                  key: minio_password

    # -------------------------------------------------------------------------
    # Ingress
    # -------------------------------------------------------------------------
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      webserver:
        host: dagster.${CLUSTER_DOMAIN}
        path: /
        pathType: Prefix
        tls:
          enabled: true
          secretName: dagster-tls

    # -------------------------------------------------------------------------
    # Storage config
    # -------------------------------------------------------------------------
    computeLogManager:
      type: S3ComputeLogManager
      config:
        s3ComputeLogManager:
          bucket: lotus-lake-logs
          endpointUrl: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
          skipEmptyFiles: true
