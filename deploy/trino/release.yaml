# ==============================================================================
# Trino Helm Release (lotus-lake)
# ==============================================================================
# Query engine for this lake - workers run where data lives
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: trino
  namespace: lotus-lake
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: trino
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: trino
        namespace: flux-system

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    # -------------------------------------------------------------------------
    # Server config
    # -------------------------------------------------------------------------
    server:
      workers: 1
      config:
        query:
          maxMemory: "4GB"
          maxMemoryPerNode: "4GB"
        memory:
          heapHeadroomPerNode: "2GB"

    # -------------------------------------------------------------------------
    # Coordinator - lightweight, can run anywhere
    # -------------------------------------------------------------------------
    coordinator:
      jvm:
        maxHeapSize: "4G"
      resources:
        requests:
          memory: "4Gi"
          cpu: "500m"
        limits:
          memory: "6Gi"

    # -------------------------------------------------------------------------
    # Worker - runs where data lives (bulk storage nodes)
    # -------------------------------------------------------------------------
    worker:
      jvm:
        maxHeapSize: "8G"
      nodeSelector:
        storage.h-kube.io/bulk: "true"
      resources:
        requests:
          memory: "8Gi"
          cpu: "1"
        limits:
          memory: "12Gi"

    # -------------------------------------------------------------------------
    # Environment variables from secret (for catalog credentials)
    # -------------------------------------------------------------------------
    env:
      - name: S3_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: lotus-lake-s3-creds
            key: access-key
      - name: S3_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: lotus-lake-s3-creds
            key: secret-key

    # -------------------------------------------------------------------------
    # Iceberg catalog pointing to shared Nessie + SeaweedFS
    # -------------------------------------------------------------------------
    additionalCatalogs:
      iceberg: |
        connector.name=iceberg
        iceberg.catalog.type=nessie
        iceberg.nessie-catalog.uri=http://nessie.nessie.svc.cluster.local:19120/api/v1
        iceberg.nessie-catalog.default-warehouse-dir=s3://lotus-lake/iceberg/
        iceberg.nessie-catalog.ref=main
        fs.native-s3.enabled=true
        s3.endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
        s3.path-style-access=true
        s3.region=us-east-1
        s3.aws-access-key=${ENV:S3_ACCESS_KEY}
        s3.aws-secret-key=${ENV:S3_SECRET_KEY}
