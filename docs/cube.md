# Cube.js Semantic Layer

## Overview

Cube.js provides a semantic layer over DuckLake, exposing data via:
- **PostgreSQL protocol** (port 5432) - for BI tools like Power BI, Tableau, DBeaver
- **REST API** (port 4000) - for custom applications

Cube.js connects to DuckLake using an in-memory DuckDB instance with the DuckLake catalog attached.

## Production Architecture

Cube.js runs in production mode with 4 components:

```
┌─────────────────────────────────────────────────────────────┐
│                 CUBE.JS PRODUCTION ARCHITECTURE              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐                                           │
│  │  Cube API    │   ← Deployment (1 pod)                    │
│  │  :4000 REST  │     Handles REST + SQL requests           │
│  │  :5432 SQL   │     Stateless, can scale horizontally     │
│  └──────┬───────┘                                           │
│         │                                                    │
│         ▼                                                    │
│  ┌──────────────────────────┐                               │
│  │  Cube Store Router       │   ← StatefulSet (1 pod)       │
│  │  :3030 HTTP              │     Coordinates query exec    │
│  │  :9999 Meta              │     Stable DNS: cubestore-    │
│  └──────────┬───────────────┘       router-0.cubestore-     │
│             │                        router                  │
│             ▼                                                │
│  ┌──────────────────────────┐                               │
│  │  Cube Store Worker       │   ← StatefulSet (1+ pods)     │
│  │  :10001 Worker           │     Executes queries          │
│  └──────────────────────────┘     Scalable horizontally     │
│                                                              │
│  ┌──────────────────────────┐                               │
│  │  Refresh Worker          │   ← Deployment (1 pod)        │
│  │  CUBEJS_REFRESH_WORKER   │     Builds pre-aggregations   │
│  └──────────────────────────┘     in background             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Why This Architecture?

| Component | Purpose | Why Needed |
|-----------|---------|------------|
| **Cube API** | Handles client requests | Entry point for all queries |
| **Cube Store Router** | Query coordination | Manages distributed query execution |
| **Cube Store Worker** | Query execution | Actually runs queries, can scale out |
| **Refresh Worker** | Pre-aggregation builds | Offloads heavy work from API pod |

In dev mode, Cube runs everything in a single process. Production mode separates concerns for reliability and scalability.

## Connection Details

### PostgreSQL Protocol

Connect with any PostgreSQL client:

```bash
# psql
psql -h 100.64.0.5 -p 5432 -U cube -d cube

# Connection string
postgresql://cube:<password>@100.64.0.5:5432/cube
```

| Parameter | Value |
|-----------|-------|
| Host | `100.64.0.5` (Traefik node via Tailscale) |
| Port | `5432` |
| Database | `cube` |
| User | `cube` |
| Password | `CUBEJS_API_SECRET` from `lotus-lake-terraform-vars` secret |

**Get the password:**
```bash
kubectl get secret -n lotus-lake lotus-lake-terraform-vars \
  -o jsonpath='{.data.cubejs_api_secret}' | base64 -d
```

### REST API

The REST API is available on port 4000 but requires JWT authentication.

```bash
# Health check (no auth required)
curl http://cube:4000/readyz

# Meta endpoint (requires auth)
curl -H "Authorization: <JWT_TOKEN>" http://cube:4000/cubejs-api/v1/meta
```

## Cube Definitions

Cubes are defined in `orchestration/cube/model/`.

### Auto-Generated Cubes

Cubes are auto-generated from dbt manifest at Docker build time:

| File | Pattern | Source |
|------|---------|--------|
| `model/processed.js` | `int_*` | dbt intermediate models |
| `model/enriched.js` | `fct_*` | dbt fact tables |

The factory reads `target/manifest.json` (generated by `dbt parse`) and creates cube definitions dynamically.

### Manual Cubes

For custom cubes, add files to `orchestration/cube/model/`:

```javascript
// model/custom.js
cube(`my_custom_cube`, {
  sql_table: `lakehouse.main.my_table`,

  dimensions: {
    id: {
      sql: `id`,
      type: `number`,
      primary_key: true
    },
    name: {
      sql: `name`,
      type: `string`
    }
  },

  measures: {
    count: {
      type: `count`
    },
    total_amount: {
      sql: `amount`,
      type: `sum`
    }
  }
});
```

### Cube Configuration

Main config in `orchestration/cube/cube.js`:

```javascript
module.exports = {
  dbType: 'duckdb',

  driverFactory: async () => {
    // Creates DuckDB with DuckLake attached
    // S3 credentials configured via CREATE SECRET
  },

  apiSecret: process.env.CUBEJS_API_SECRET,
  sqlPort: 5432,
  sqlUser: 'cube',
  sqlPassword: process.env.CUBEJS_API_SECRET,
};
```

## Environment Variables

### Cube API & Refresh Worker

| Variable | Value | Purpose |
|----------|-------|---------|
| `CUBEJS_DEV_MODE` | `false` | Production mode |
| `CUBEJS_CACHE_AND_QUEUE_DRIVER` | `cubestore` | Use external Cube Store |
| `CUBEJS_CUBESTORE_HOST` | `cubestore-router` | Cube Store router service |
| `CUBEJS_CUBESTORE_PORT` | `3030` | Cube Store HTTP port |
| `CUBEJS_PG_SQL_PORT` | `5432` | Enable SQL API |
| `CUBEJS_DB_TYPE` | `duckdb` | Database type |
| `CUBEJS_API_SECRET` | (from secret) | API authentication |
| `DUCKLAKE_DB_HOST` | `ducklake-db-rw...` | DuckLake catalog |
| `DUCKLAKE_DB_PASSWORD` | (from secret) | DuckLake password |
| `CUBEJS_DB_DUCKDB_S3_*` | (various) | S3 credentials for DuckDB |

### Cube Store Router

| Variable | Value | Purpose |
|----------|-------|---------|
| `CUBESTORE_SERVER_NAME` | `cubestore-router-0:9999` | Router identity |
| `CUBESTORE_HTTP_PORT` | `3030` | HTTP API port |
| `CUBESTORE_META_PORT` | `9999` | Metadata port |
| `CUBESTORE_WORKERS` | `cubestore-worker-0.cubestore-worker:10001` | Worker list |

### Cube Store Worker

| Variable | Value | Purpose |
|----------|-------|---------|
| `CUBESTORE_SERVER_NAME` | `cubestore-worker-0:10001` | Worker identity |
| `CUBESTORE_WORKER_PORT` | `10001` | Worker port |
| `CUBESTORE_META_ADDR` | `cubestore-router-0.cubestore-router:9999` | Router address |

## Deployment

Cube.js is deployed via raw Kubernetes manifests in h-kube:

```
h-kube/cluster/infrastructure/services/cube/
├── deployment.yaml    # All 4 components + services
├── tcp-route.yaml     # Traefik TCP route for port 5432
└── kustomization.yaml
```

### Updating Cube

1. Make changes to `orchestration/cube/` in lotus-lake repo
2. Push to trigger Docker build (GitHub Actions)
3. Rollout restart to pick up new image:

```bash
kubectl rollout restart deployment/cube -n lotus-lake
kubectl rollout restart deployment/cube-refresh-worker -n lotus-lake
```

### Scaling Workers

To add more Cube Store workers, edit `deployment.yaml`:

```yaml
# In cubestore-worker StatefulSet
spec:
  replicas: 2  # Increase from 1

# In cubestore-router env
- name: CUBESTORE_WORKERS
  value: "cubestore-worker-0.cubestore-worker:10001,cubestore-worker-1.cubestore-worker:10001"
```

## Troubleshooting

### Check Pod Status

```bash
kubectl get pods -n lotus-lake | grep -E 'cube|cubestore'
# Expected: 4 pods all Running
```

### Check Logs

```bash
# Cube API
kubectl logs -n lotus-lake deploy/cube

# Cube Store Router
kubectl logs -n lotus-lake cubestore-router-0

# Cube Store Worker
kubectl logs -n lotus-lake cubestore-worker-0

# Refresh Worker
kubectl logs -n lotus-lake deploy/cube-refresh-worker
```

### Health Checks

```bash
# From within cluster
kubectl exec -n lotus-lake deploy/cube -- \
  node -e "require('http').get('http://localhost:4000/readyz', r => { let d=''; r.on('data', c => d+=c); r.on('end', () => console.log(d)) })"

# Check Cube Store Router
kubectl exec -n lotus-lake deploy/cube -- \
  node -e "require('http').get('http://cubestore-router:3031/readyz', r => console.log('Status:', r.statusCode))"
```

### Common Issues

| Symptom | Cause | Fix |
|---------|-------|-----|
| "Cube Store is not found" | Missing `CUBEJS_CACHE_AND_QUEUE_DRIVER=cubestore` | Add env var, restart |
| SQL API not listening | Wrong env var name | Use `CUBEJS_PG_SQL_PORT` not `CUBEJS_SQL_PORT` |
| Worker DNS errors on startup | Race condition | Usually self-resolves after router is ready |
| 403 on REST API | Missing/invalid JWT | Use PostgreSQL protocol instead, or generate JWT |
| No cubes visible | dbt manifest missing | Run `dbt parse`, rebuild Docker image |

### Test PostgreSQL Connection

```bash
# From cluster
kubectl run test-psql --rm -i --image=postgres:15 --restart=Never -n lotus-lake \
  --env="PGPASSWORD=<secret>" -- \
  psql -h cube -p 5432 -U cube -d cube -c "SELECT 1"

# List available cubes
psql -h cube -p 5432 -U cube -d cube -c "\dt"
```

## Resources

- [Cube.js Documentation](https://cube.dev/docs)
- [SQL API Reference](https://cube.dev/docs/product/apis-integrations/sql-api)
- [Production Deployment](https://cube.dev/docs/product/deployment)
- [Environment Variables](https://cube.dev/docs/product/configuration/reference/environment-variables)
